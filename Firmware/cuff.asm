.include "tn4def.inc"


.equ    LED = 0				; LED connected to PB0
.equ	DELAYTIME = 17		; 17 ms between PWM changes

; if you use the HEARTBEAT patterns the delay should be 2-4ms
; .equ  DELAYTIME = 2

.cseg 

.org 0x0000
	rjmp	RESET

.def	temp   		= R16	; general purpose temp
.def	delaycnt1  	= R17   ; counter for 1ms delay loop
.def	delayms  	= R28	; keeps track of how many ms left in delay

RESET:
	sbi		DDRB, LED		; LED output
	sbi		PORTB, LED    	; LED off

	; set up fast PWM output timer WGM[3:0] = 0101
	; COM0A1 = 1, COM0A0 = 0 or 1
	ldi		temp, 0xC1		;  Fast PWM (PB2 output)
	out		TCCR0A, temp
	ldi		temp, 0x81      ; fastest clock
	out		TCCR0B, temp

	; we dont use the top of the counter since its only 8 bit
	ldi		temp, 0
	out		OCR0AH, temp


LOOPSTART:
   	ldi ZH, high(PULSETAB*2) + 0x40   ; This is start of Code in Tiny4 (0x4000)
   	ldi ZL, low (PULSETAB*2) 		; init Z-pointer to storage bytes 
LOOP:
	ld		temp, Z+			; load next led brightness
	cpi		temp, 0			; last entry?
	brne	NORELOAD
	; if temp == 0, means we reached the end, so reload the table index
    rjmp    LOOPSTART

NORELOAD:

	out		OCR0AL, temp	; Shove the brightness into the PWM driver

	; delay!
	ldi		delayms, DELAYTIME			; delay ~17 ms
DELAY:
	ldi		delaycnt1, 0xFF
	DELAY1MS:   ; this loop takes about 1ms (with 1 MHz clock)
		dec		delaycnt1      ; 1 clock
		cpi		delaycnt1, 0   ; 1 clock
		brne	DELAY1MS       ; 2 clocks (on avg)
	dec		delayms
	cpi		delayms, 0
	brne	DELAY

	rjmp	LOOP


PULSETAB:
.db 255, 255, 255, 255, 255, 255, 255, 255, 252, 247, 235, 235, 230, 225, 218, 213, 208, 206, 199, 189, 187, 182, 182, 177, 175, 168, 165, 163, 158, 148, 146, 144, 144, 141, 139, 136, 134, 127, 122, 120, 117, 115, 112, 112, 110, 110, 108, 103, 96, 96, 93, 91, 88, 88, 88, 88, 84, 79, 76, 74, 74, 72, 72, 72, 72, 69, 69, 62, 60, 60, 57, 57, 57, 55, 55, 55, 55, 48, 48, 45, 45, 43, 43, 40, 40, 40, 40, 36, 36, 36, 33, 33, 31, 31, 31, 28, 28, 26, 26, 26, 26, 24, 24, 21, 21, 21, 21, 20, 19, 19, 16, 16, 16, 16, 14, 14, 14, 16, 12, 12, 12, 12, 12, 9, 9, 9, 9, 9, 9, 7, 7, 7, 7, 7, 7, 4, 4, 4, 4, 4, 4, 4, 4, 4, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 4, 4, 4, 4, 4, 7, 7, 7, 7, 7, 7, 9, 9, 9, 12, 12, 12, 14, 14, 16, 16, 16, 16, 21, 21, 21, 21, 24, 24, 26, 28, 28, 28, 31, 36, 33, 36, 36, 40, 40, 43, 43, 45, 48, 52, 55, 55, 55, 57, 62, 62, 64, 67, 72, 74, 79, 81, 86, 86, 86, 88, 93, 96, 98, 100, 112, 115, 117, 124, 127, 129, 129, 136, 141, 144, 148, 160, 165, 170, 175, 184, 189, 194, 199, 208, 213, 220, 237, 244, 252, 255, 255, 255, 255, 255, 255, 255, 0

/*
HEARTBEAT1:
.db 114, 114, 115, 117, 117, 117, 118, 119, 121, 122, 124, 124, 126, 124, 119, 112, 107, 103, 100, 100, 100, 100, 98, 95, 92, 87, 81, 75, 68, 62, 57, 56, 59, 65, 75, 88, 103, 118, 134, 149, 163, 174, 183, 188, 190, 190, 188, 187, 189, 192, 195, 198, 199, 200, 199, 197, 194, 190, 186, 180, 174, 168, 162, 155, 148, 140, 133, 126, 118, 111, 103, 96, 89, 82, 74, 67, 60, 53, 46, 39, 33, 26, 21, 15, 11, 7, 4, 3, 3, 3, 2, 1, 1, 1, 1, 2, 5, 8, 12, 17, 23, 28, 34, 40, 47, 55, 63, 72, 80, 90, 98, 108, 117, 126, 136, 145, 154, 162, 170, 178, 185, 191, 198, 203, 207, 211, 214, 217, 218, 220, 221, 221, 221, 221, 220, 219, 217, 215, 213, 211, 208, 205, 202, 200, 197, 194, 192, 189, 186, 183, 179, 176, 172, 168, 165, 161, 157, 153, 149, 144, 140, 136, 131, 127, 123, 118, 114, 110, 105, 101, 97, 92, 88, 84, 80, 76, 72, 68, 65, 61, 58, 54, 51, 49, 46, 44, 41, 40, 38, 37, 36, 35, 35, 34, 35, 35, 36, 36, 38, 39, 41, 43, 45, 47, 50, 52, 55, 58, 61, 63, 66, 70, 73, 76, 79, 82, 85, 88, 91, 94, 97, 100, 103, 105, 108, 111, 113, 116, 118, 120, 122, 125, 126, 128, 130, 132, 134, 135, 137, 138, 140, 141, 143, 144, 145, 146, 147, 148, 149, 150, 151, 152, 153, 154, 154, 155, 155, 156, 156, 156, 157, 157, 157, 157, 157, 157, 156, 156, 156, 155, 155, 154, 154, 153, 152, 151, 150, 149, 148, 147, 146, 145, 143, 142, 141, 139, 138, 136, 135, 133, 132, 130, 128, 127, 125, 123, 121, 120, 118, 117, 115, 114, 112, 111, 109, 108, 106, 105, 104, 103, 102, 101, 100, 99, 98, 97, 97, 96, 95, 95, 94, 94, 93, 93, 93, 93, 93, 92, 92, 92, 92, 92, 93, 93, 93, 93, 93, 93, 94, 94, 94, 95, 95, 95, 96, 96, 97, 97, 97, 98, 98, 98, 99, 99, 100, 100, 101, 101, 102, 102, 103, 103, 104, 104, 105, 105, 106, 106, 107, 107, 108, 108, 109, 110, 110, 111, 111, 112, 112, 113, 113, 114, 114, 115, 115, 116, 116, 117, 117, 118, 118, 119, 119, 119, 120, 120, 120, 121, 121, 121, 121, 122, 122, 122, 122, 122, 123, 123, 123, 123, 123, 123, 123, 123, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 123, 123, 123, 123, 123, 123, 123, 123, 123, 122, 122, 122, 122, 122, 122, 121, 121, 121, 121, 120, 120, 120, 120, 119, 119, 119, 119, 119, 118, 118, 118, 117, 117, 117, 117, 117, 116, 116, 116, 116, 116, 115, 115, 115, 115, 115, 115, 114, 114, 114, 114, 114, 114, 114, 113, 113, 113, 113, 113, 113, 113, 113, 112, 112, 112, 112, 112, 112, 112, 112, 112, 112, 112, 112, 112, 112, 111, 111, 111, 111, 111, 111, 111, 111, 111, 111, 111, 111, 111, 111, 112, 112, 111, 112, 112, 112, 112, 112, 112, 112, 112, 112, 112, 112, 112, 112, 112, 112, 112, 112, 112, 112, 113, 113, 113, 113, 113, 113, 113, 113, 113, 113, 113, 113, 113, 113, 113, 113, 113, 113, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 0
*/

/*
HEARTBEAT2:
.db 120, 120, 120, 119, 119, 119, 117, 117, 117, 116, 116, 115, 115, 115, 106, 98, 96, 101, 111, 122, 131, 138, 142, 143, 143, 144, 146, 150, 155, 161, 168, 176, 184, 190, 194, 193, 187, 176, 162, 145, 127, 109, 91, 74, 59, 46, 35, 28, 24, 23, 21, 17, 12, 9, 8, 7, 8, 11, 14, 19, 25, 31, 37, 44, 53, 62, 71, 80, 90, 100, 112, 123, 134, 144, 153, 162, 171, 179, 186, 193, 200, 206, 211, 215, 219, 225, 231, 237, 241, 244, 245, 246, 245, 244, 245, 247, 248, 248, 248, 245, 241, 236, 230, 224, 218, 211, 204, 196, 187, 178, 168, 158, 148, 138, 128, 118, 108, 99, 89, 80, 71, 62, 54, 47, 40, 33, 27, 21, 16, 12, 8, 5, 3, 1, 1, 1, 1, 1, 2, 4, 6, 8, 11, 14, 17, 20, 24, 27, 31, 34, 37, 40, 43, 47, 50, 54, 58, 62, 66, 70, 75, 80, 84, 89, 95, 99, 105, 110, 115, 120, 125, 130, 135, 140, 145, 150, 155, 160, 164, 169, 173, 177, 182, 186, 189, 193, 196, 199, 202, 204, 206, 208, 209, 209, 210, 210, 210, 210, 210, 209, 208, 206, 205, 203, 201, 198, 196, 193, 190, 187, 184, 181, 177, 174, 170, 166, 162, 159, 155, 151, 147, 144, 140, 137, 133, 130, 127, 124, 121, 118, 115, 113, 111, 108, 106, 104, 102, 100, 99, 97, 95, 94, 93, 91, 90, 89, 88, 87, 85, 84, 84, 83, 82, 81, 80, 80, 79, 79, 78, 78, 77, 77, 77, 77, 77, 77, 77, 77, 77, 77, 78, 78, 79, 79, 80, 80, 81, 82, 83, 84, 85, 86, 88, 89, 90, 91, 93, 94, 96, 97, 99, 101, 102, 104, 106, 107, 109, 111, 113, 114, 116, 118, 119, 121, 122, 124, 125, 127, 128, 130, 131, 132, 134, 135, 136, 137, 138, 139, 139, 140, 141, 142, 142, 143, 143, 143, 144, 144, 144, 144, 144, 145, 145, 145, 145, 144, 144, 144, 144, 144, 143, 143, 143, 143, 142, 142, 142, 141, 141, 140, 140, 139, 139, 138, 138, 137, 137, 136, 136, 135, 135, 134, 133, 133, 132, 132, 131, 130, 130, 129, 129, 128, 128, 127, 127, 126, 125, 125, 124, 124, 123, 122, 122, 121, 121, 120, 120, 119, 119, 118, 118, 117, 117, 116, 116, 116, 115, 115, 114, 114, 114, 113, 113, 113, 112, 112, 112, 111, 111, 111, 111, 111, 111, 110, 110, 110, 110, 110, 110, 110, 110, 110, 110, 110, 110, 110, 110, 111, 111, 111, 111, 111, 111, 111, 111, 112, 112, 112, 112, 112, 113, 113, 113, 113, 113, 114, 114, 114, 114, 115, 115, 115, 115, 116, 116, 116, 116, 116, 117, 117, 117, 118, 118, 118, 118, 119, 119, 119, 119, 120, 120, 120, 120, 120, 121, 121, 121, 121, 121, 122, 122, 122, 122, 122, 122, 123, 123, 123, 123, 123, 123, 123, 123, 123, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 122, 122, 122, 122, 122, 122, 122, 122, 122, 122, 122, 122, 121, 121, 121, 121, 121, 121, 121, 121, 121, 121, 121, 121, 121, 121, 121, 121, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 119, 119, 120, 119, 119, 119, 119, 119, 119, 119, 119, 119, 119, 119, 119, 120, 119, 119, 120, 119, 120, 120, 119, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 0
*/



